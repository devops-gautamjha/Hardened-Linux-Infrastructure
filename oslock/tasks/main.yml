---
# tasks file for oslock

- name: Ensure Required Variable is provided by user
  assert:
    that: 
      - SSH_PUBLIC_KEY is defined
      - SSH_PUBLIC_KEY != ''
    fail_msg: "You must provide your public SSH key so that you can log in to the server after hardening."

- name: Updating apt packages 
  apt: "*"
  state: latest

- name: Upgrading the dist 
  apt: 
    upgrade: dist


- name: Creating New User
  user: 
    name: {{ NEW_USER }}
    create_home: yes
    shell: /bin/bash

- name: Creating SSH directory if doesn't exist and giving it right permission
  file: 
    path: /home/{{ NEW_USER }}/.ssh
    state: directory
    mode: '0700'
    owner: "{{ NEW_USER }}"
    group: "{{ NEW_USER }}"

- name: Adding Public SSH key in authorized key file
  template: 
    src: authorized_keys.j2
    dest: /home/{{ NEW_USER }}/.ssh/authorized_keys
    group: {{ NEW_USER }}
    owner: {{ NEW_USER }}
    mode: '0600'

- name: Removing Every other configs that can override default sshd config 
  file: 
    path: 
      - "/etc/ssh/sshd_config.d/"
      - "/etc/ssh/ssh_config.d/"
    state: absent
  with_fileglob:
    - "/etc/ssh/sshd_config.d/*"
    - "/etc/ssh/ssh_config.d/*"

- name: Creating Sshd Config 
  template: 
    src: sshd_config.j2
    dest: /etc/ssh/sshd_config
    group: root
    owner: root 
    mode: '0644'


- name: Installing UFW firewall 
  apt:
    name: ufw
    state: present
    update_cache: yes

- name: Deny incomming request on all ports 
  ufw: 
    direction: incoming
    policy: deny
- name: Allow all outgoing request 
  ufw: 
    direction: outgoing
    policy: allow
- name: Allow SSH port 
  ufw:
    rule: allow
    port: "{{ NEW_SSH_PORT }}"
    proto: tcp

